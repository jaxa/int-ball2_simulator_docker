services:
  simulator:
    image: ib2_simulator:latest
    container_name: ib2_simulator
    runtime: nvidia
    privileged: true
    network_mode: host
    ipc: host
    environment:
      - DISPLAY=host.docker.internal:0.0  # Windows用の設定
      - LIBGL_ALWAYS_INDIRECT=1
      - QT_X11_NO_MITSHM=1
      - MESA_GL_VERSION_OVERRIDE=3.3
    tty: true
    # systemd用の必須設定
    cap_add:
      - SYS_ADMIN
    security_opt:
      - seccomp:unconfined
    tmpfs:
      - /run
      - /run/lock
    volumes: 
      - ./shared_data:/home/shared_data:rw
      - /var/run/docker.sock:/var/run/docker.sock
      - /sys/fs/cgroup:/sys/fs/cgroup:ro  # systemd用のcgroupマウント
    command: /sbin/init # 初期化スクリプトを実行せず、systemdのみを起動

  prog:
    image: ib2_user:0.1
    container_name: ib2_user
    privileged: true
    network_mode: host
    depends_on:
      - simulator
    environment:
      - DISPLAY=host.docker.internal:0.0  # Windows用の設定
      - QT_X11_NO_MITSHM=1
    volumes:
      - ./shared_data:/home/shared_data:rw